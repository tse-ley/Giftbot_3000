{% extends 'base.html.twig' %}

{% block title %}GiftBot 3000 - Recherche Intelligente{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ asset('build/giftsearch.css') }}">
    <link rel="stylesheet" href="{{ asset('build/navbar.css') }}">
    <link rel="stylesheet" href="{{ asset('build/footer.css') }}">
{% endblock %}

{% block body %}
    {% include 'components/_navbar.html.twig' %}

    <div class="main-container">
        <!-- Hero Section -->
        <section class="hero-section">
            <h1 class="hero-title">Votre Cadeau Parfait Vous Attend...</h1>
            <div class="hero-content ">
                <div class="hero-image">
                    <img src="https://images.unsplash.com/photo-1513475382585-d06e58bcb0e0?w=300&h=200&fit=crop" alt="Gift Search" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                    <div style="display:none; width:100%; height:100%; background: linear-gradient(135deg, var(--light-pink), var(--primary-pink)); align-items:center; justify-content:center; color:white; font-size:2rem;">
                        <i class="fas fa-search"></i>
                    </div>
                </div>
                <div class="hero-text">
                    <p class="hero-description">
                        Notre moteur de recherche intelligent analyse vos critères 
                        (budget, occasion, centres d'intérêt) pour dénicher des 
                        pépites adaptées. Plus besoin de chercher pendant des heures. 
                        Laissez notre technologie vous proposer des idées qui font 
                        mouche à coup sûr!
                    </p>
                </div>
            </div>
        </section>

        <!-- Search Section -->
        <section class="search-section">
            <h2 class="search-title">Trouvez le Cadeau Idéal en Quelques Clics !</h2>
            {{ form_start(searchForm, {'attr': {'id': 'gift-search-form', 'class': 'search-form'}}) }}
                {{ form_row(searchForm.category, {'attr': {'class': 'form-input'}, 'label_attr': {'class': 'form-label'}, 'row_attr': {'class': 'form-group'}}) }}
                {{ form_row(searchForm.label, {'attr': {'class': 'form-input'}, 'label_attr': {'class': 'form-label'}, 'row_attr': {'class': 'form-group'}}) }}
                <button type="submit" class="btn btn-primary search-btn">Rechercher</button>
            {{ form_end(searchForm) }}
        </section>

        <!-- Results Section -->
        <section class="results-section">
            <h2 class="results-title">Our findings..</h2>
            <p class="results-subtitle">In Store products</p>
            
            <div class="results-container" id="resultsContainer">
                <div id="results-section">
                    <div id="searchStats"></div>
                    <div id="resultsList"></div>
                </div>
                <!-- Loading State -->
                <div class="loading-state" id="loadingState" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>Recherche en cours...</p>
                </div>

                <!-- No Results State -->
                <div class="no-results" id="noResults">
                    <i class="fas fa-search"></i>
                    <h3>Prêt à découvrir des cadeaux parfaits ?</h3>
                    <p>Utilisez notre moteur de recherche intelligent ci-dessus pour commencer votre recherche.</p>
                </div>

                <!-- Results List -->
            </div>
        </section>
    </div>

    {% include 'components/_footer.html.twig' %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchForm = document.getElementById('gift-search-form');
            const loadingState = document.getElementById('loadingState');
            const noResults = document.getElementById('noResults');
            const resultsList = document.getElementById('resultsList');
            const resultsContainer = document.getElementById('resultsContainer');
            const searchStats = document.getElementById('searchStats');

            searchForm.addEventListener('submit', function(e) {
                e.preventDefault();
                performSearch();
            });

            function performSearch() {
                const formData = new FormData(searchForm);
                const criteria = {
                    category: formData.get('category'),
                    label: formData.get('label')
                };

                showLoadingState();

                fetch('{{ path('app_gift_search_results') }}', {
                    method: 'POST',
                    body: new FormData(searchForm),
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Search results:', data);  // <-- check what is returned
                        displayResults(data, criteria);
                    })
                    .catch(() => {
                        loadingState.style.display = 'none';
                        showNoResults();
                    });
            }

            function showLoadingState() {
                noResults.style.display = 'none';
                if (resultsList) resultsList.style.display = 'none';
                loadingState.style.display = 'flex';
            }

            function displayResults(gifts, criteria) {
                loadingState.style.display = 'none';

                if (gifts.length === 0) {
                    showNoResults();
                    return;
                }

                const criteriaText = [];
                if (criteria.category) criteriaText.push(`Catégorie: ${criteria.category}`);
                if (criteria.label) criteriaText.push(`Intérêt: ${criteria.label}`);

                searchStats.innerHTML = `
                    <strong>${gifts.length} cadeau${gifts.length > 1 ? 's' : ''} trouvé${gifts.length > 1 ? 's' : ''}</strong>
                    ${criteriaText.length > 0 ? ' - ' + criteriaText.join(' | ') : ''}
                `;

                const giftsHTML = gifts.map(gift => createGiftHTML(gift)).join('');
                
                resultsList.innerHTML = giftsHTML;
                resultsList.style.display = 'block';
                noResults.style.display = 'none';

                addCartButtonListeners();
            }

            function createGiftHTML(gift) {
                return `
                    <div class="gift-item" data-gift-id="${gift.id}">
                        <div class="gift-image">
                            <img src="/uploads/images/${gift.image}" alt="${gift.name}" class="gift-thumb">
                        </div>
                        <div class="gift-details">
                            <div class="gift-name">${gift.name}</div>
                            <div class="gift-description">${gift.description}</div>
                            <div class="gift-price">${gift.price.toFixed(2)} €</div>
                        </div>
                        <div class="gift-actions">
                            <button class="btn-add-cart" data-gift-id="${gift.id}">
                                <i class="fas fa-shopping-cart me-1"></i> Ajouter
                            </button>
                            <button class="btn-view-details" data-gift-id="${gift.id}">
                                Détails
                            </button>
                        </div>
                    </div>
                `;
            }


            function showNoResults() {
                if (resultsList) resultsList.style.display = 'none';
                noResults.innerHTML = `
                    <i class="fas fa-search"></i>
                    <h3>Aucun cadeau trouvé</h3>
                    <p>Essayez de modifier vos critères de recherche pour découvrir plus d'options.</p>
                `;
                noResults.style.display = 'block';
            }

            function addCartButtonListeners() {
                document.querySelectorAll('.btn-add-cart').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const giftId = this.dataset.giftId;
                        const originalHTML = this.innerHTML;

                        this.innerHTML = '<i class="fas fa-check me-1"></i>Ajouté!';
                        this.style.background = '#4caf50';

                        setTimeout(() => {
                            this.innerHTML = originalHTML;
                            this.style.background = '';
                        }, 2000);

                        console.log('Added gift to cart:', giftId);
                    });
                });

                document.querySelectorAll('.btn-view-details').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const giftId = this.dataset.giftId;
                        console.log('View details for gift:', giftId);
                        // window.location.href = `/gift/${giftId}`;
                    });
                });
            }

            document.querySelectorAll('.form-input').forEach(input => {
                input.addEventListener('change', function() {
                    // Uncomment to enable auto-search
                    // performSearch();
                });
            });
        });
    </script>
{% endblock %}
